# Differential Expression Analysis (DEA) Subworkflow

## Overview
The `differential_expression_analysis_wf` subworkflow performs **differential expression analysis (DEA)** on transcript quantification data obtained from **Single-End (SE) and Paired-End (PE) RNA-seq** experiments. It takes as input `.h5` abundance files generated by Kallisto and processes them using **Sleuth**, producing statistical results, principal component analysis (PCA) plots, heatmaps, and bootstrap confidence intervals.

This subworkflow ensures a streamlined and standardized approach to DEA, allowing both SE and PE quantifications to be analyzed efficiently within the same pipeline.

## Why This Subworkflow Exists
DEA is a critical step in transcriptomic analysis, enabling the identification of **differentially expressed genes or transcripts** between conditions (e.g., treated vs. untreated samples). This subworkflow:
- **Processes Kallisto quantifications** for SE and PE data separately.
- **Runs Sleuth** to perform **Likelihood Ratio Tests (LRT) and Wald Tests**.
- **Generates key visualizations** for exploratory data analysis.
- **Ensures modularity**, allowing independent execution for SE and PE datasets.

## How It Works
The subworkflow follows these major steps:

1. **Takes in `.h5` abundance files** from SE and PE transcript quantifications.
2. **Runs DEA separately** for SE and PE samples:
   - Calls `transcriptome_dea_se_wf` for **SE analysis**.
   - Calls `transcriptome_dea_pe_wf` for **PE analysis**.
3. **Performs statistical tests** using Sleuth:
   - **Likelihood Ratio Test (LRT):** Detects global transcript expression differences across conditions.
   - **Wald Test:** Evaluates pairwise differences between conditions.
4. **Generates visualizations** to aid interpretation:
   - **PCA plots:** Identify clustering patterns among samples.
   - **Heatmaps:** Display transcript expression patterns.
   - **Bootstrap plots:** Show confidence intervals for expression estimates.
5. **Outputs structured metadata and results** for downstream interpretation.

## Submodules Used
This subworkflow calls the following **containerized** submodules:

- **Single-End Differential Expression Analysis:** [`transcriptome_dea_se_wf`](../../submodules/transcriptome_dea/README.md)
- **Paired-End Differential Expression Analysis:** [`transcriptome_dea_pe_wf`](../../submodules/transcriptome_dea/README.md)

Refer to their respective README files for details on implementation and parameters.

## Input Parameters
| Parameter             | Description                                                      | Example Value  |
|-----------------------|------------------------------------------------------------------|---------------|
| `se_abundance_h5s`   | List of `.h5` abundance files from SE quantification             | `[ "/path/to/se1.h5", "/path/to/se2.h5" ]` |
| `pe_abundance_h5s`   | List of `.h5` abundance files from PE quantification             | `[ "/path/to/pe1.h5", "/path/to/pe2.h5" ]` |
| `results_dir`        | Directory for storing differential expression analysis results (will create `differential_expression_analysis` subfolder) | `/path/to/results` |

## How to Run
Run the subworkflow using Nextflow and Docker:

```
nextflow run main.nf -params-file test_input.json -with-docker
```

This will execute the subworkflow using the parameters defined in `test_input.json`. Example:

```json
{
    "se_abundance_h5s": [
        "/path/to/transcriptome_analysis/transcriptome_quantification/single_end/Treated1_se_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/single_end/Treated2_se_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/single_end/Untreated1_se_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/single_end/Untreated2_se_abundance.h5"
    ],
    "pe_abundance_h5s": [
        "/path/to/transcriptome_analysis/transcriptome_quantification/paired_end/Treated1_pe_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/paired_end/Treated2_pe_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/paired_end/Untreated1_pe_abundance.h5",
        "/path/to/transcriptome_analysis/transcriptome_quantification/paired_end/Untreated2_pe_abundance.h5"
    ],
    "results_dir": "/path/to/results"
}
```

## Expected Outputs
| Output                                      | Description                                                 |
|--------------------------------------------|-------------------------------------------------------------|
| `se_sleuth_metadata_ch`                    | Metadata file used for SE DEA                               |
| `se_sleuth_lrt_results_ch`                 | SE Likelihood Ratio Test (LRT) results                     |
| `se_sleuth_wald_results_ch`                | SE Wald Test results                                       |
| `se_sleuth_pca_plot_ch`                    | SE Principal Component Analysis (PCA) plot                 |
| `se_sleuth_heatmap_plot_ch`                | SE sample similarity heatmap                               |
| `se_sleuth_transcript_heatmap_plot_ch`     | SE transcript-level expression heatmap                     |
| `se_sleuth_bootstrap_plot_ch`              | SE bootstrap confidence intervals plot                     |
| `pe_sleuth_metadata_ch`                    | Metadata file used for PE DEA                               |
| `pe_sleuth_lrt_results_ch`                 | PE Likelihood Ratio Test (LRT) results                     |
| `pe_sleuth_wald_results_ch`                | PE Wald Test results                                       |
| `pe_sleuth_pca_plot_ch`                    | PE Principal Component Analysis (PCA) plot                 |
| `pe_sleuth_heatmap_plot_ch`                | PE sample similarity heatmap                               |
| `pe_sleuth_transcript_heatmap_plot_ch`     | PE transcript-level expression heatmap                     |
| `pe_sleuth_bootstrap_plot_ch`              | PE bootstrap confidence intervals plot                     |

## Decisions Taken
- The pipeline processes **SE and PE samples independently**, allowing flexibility.
- Sleuth **performs both LRT and Wald tests** for comprehensive DEA results.
- **PCA plots, heatmaps, and bootstrap plots** are generated to assist in data interpretation.
- The workflow **ensures modularity**, allowing submodules to be run independently if needed.

